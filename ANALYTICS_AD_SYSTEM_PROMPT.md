# ğŸ“Š ì›¹ ë¶„ì„ + ê´‘ê³  QR ì‹œìŠ¤í…œ ì„¤ê³„ í”„ë¡¬í”„íŠ¸

## ğŸ“‹ ê°œìš”

Letter Community ì„œë¹„ìŠ¤ì˜ ì‚¬ìš©ì í–‰ë™ ì¶”ì  ë° **ê´‘ê³  QR ëœë”© í˜ì´ì§€** ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥

1. **ì¼ë°˜ ë¶„ì„**: QR ì½”ë“œ ì ‘ê·¼, ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± êµ¬ë¶„, ìœ ì… ê²½ë¡œ ì¶”ì 
2. **ê´‘ê³  QR ì‹œìŠ¤í…œ**: ì‹¤ë¬¼ í¸ì§€ì— ê´‘ê³ ì£¼ QR ì‚½ì… â†’ Letter ëœë”© í˜ì´ì§€ â†’ ê´‘ê³ ì£¼ ì‚¬ì´íŠ¸ ë¦¬ë‹¤ì´ë ‰íŠ¸

---

## ğŸ¯ ê´‘ê³  QR í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ì‹¤ë¬¼ í¸ì§€ (ì˜¤í”„ë¼ì¸)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ QR ì½”ë“œ  â”‚ â† ê´‘ê³ ì£¼ QR (ì˜ˆ: ì¹´í˜, ê½ƒì§‘, ì›¨ë”©í™€ ë“±)                  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ ìŠ¤ìº”
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Letter ëœë”© í˜ì´ì§€ (letter.community/ad/[adId])         â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ‰ íŠ¹ë³„í•œ í˜œíƒì´ ì¤€ë¹„ë˜ì–´ ìˆì–´ìš”!                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  [ê´‘ê³ ì£¼ ë¡œê³ ]                                                â”‚   â”‚
â”‚  â”‚  "ê²°í˜¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ í• ì¸ 10%"                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚  â”‚      ğŸ’ í˜œíƒ ë°›ìœ¼ëŸ¬ ê°€ê¸° â†’            â”‚ â† í´ë¦­ ì¶”ì         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Letter Community ì œê³µ                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“Š ì¶”ì  ë°ì´í„°: ë…¸ì¶œìˆ˜, ì²´ë¥˜ì‹œê°„, í´ë¦­ìˆ˜, ê¸°ê¸°ì •ë³´, ìœ ì…ê²½ë¡œ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ í´ë¦­
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ê´‘ê³ ì£¼ ì‚¬ì´íŠ¸ (ì™¸ë¶€)                              â”‚
â”‚                    https://advertiser.com/promo                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ ë°ì´í„° ìŠ¤í‚¤ë§ˆ

### 1. Advertisement (ê´‘ê³ ) - MongoDB

```javascript
{
  _id: ObjectId,

  // ê¸°ë³¸ ì •ë³´
  name: String,                    // ê´‘ê³ ëª… (ë‚´ë¶€ìš©)
  slug: String,                    // URLìš© ìŠ¬ëŸ¬ê·¸ (unique)
  status: String,                  // 'draft', 'active', 'paused', 'expired'

  // ê´‘ê³ ì£¼ ì •ë³´
  advertiser: {
    name: String,                  // ê´‘ê³ ì£¼ëª… (ì˜ˆ: "í”Œë¼ì›Œì¹´í˜")
    logo: String,                  // ë¡œê³  ì´ë¯¸ì§€ URL
    contactEmail: String,          // ë‹´ë‹¹ì ì´ë©”ì¼
    contactPhone: String,          // ë‹´ë‹¹ì ì—°ë½ì²˜
  },

  // ê´‘ê³  ì½˜í…ì¸ 
  content: {
    headline: String,              // í—¤ë“œë¼ì¸ (ì˜ˆ: "ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ í• ì¸!")
    description: String,           // ì„¤ëª… í…ìŠ¤íŠ¸
    ctaText: String,               // CTA ë²„íŠ¼ í…ìŠ¤íŠ¸ (ì˜ˆ: "í˜œíƒ ë°›ìœ¼ëŸ¬ ê°€ê¸°")
    targetUrl: String,             // ê´‘ê³ ì£¼ ì‚¬ì´íŠ¸ URL
    backgroundImage: String,       // ë°°ê²½ ì´ë¯¸ì§€ (ì„ íƒ)
    backgroundColor: String,       // ë°°ê²½ ìƒ‰ìƒ
    theme: String,                 // í…Œë§ˆ ('wedding', 'birthday', 'general' ë“±)
  },

  // ìº í˜ì¸ ì„¤ì •
  campaign: {
    name: String,                  // ìº í˜ì¸ëª… (ì˜ˆ: "2024 ë´„ ì›¨ë”© ì‹œì¦Œ")
    startDate: Date,               // ì‹œì‘ì¼
    endDate: Date,                 // ì¢…ë£Œì¼
    budget: Number,                // ì˜ˆì‚° (ì„ íƒ)
    targetImpressions: Number,     // ëª©í‘œ ë…¸ì¶œìˆ˜ (ì„ íƒ)
    targetClicks: Number,          // ëª©í‘œ í´ë¦­ìˆ˜ (ì„ íƒ)
  },

  // ì—°ê²°ëœ í¸ì§€ (ì–´ë–¤ í¸ì§€ì— ì´ ê´‘ê³ ê°€ í¬í•¨ë˜ëŠ”ì§€)
  linkedLetters: [{
    letterId: ObjectId,
    letterType: String,            // 'wedding', 'birthday' ë“±
    addedAt: Date,
  }],

  // í†µê³„ (ì‹¤ì‹œê°„ ì§‘ê³„)
  stats: {
    impressions: Number,           // ë…¸ì¶œìˆ˜ (ëœë”© í˜ì´ì§€ ì¡°íšŒ)
    clicks: Number,                // í´ë¦­ìˆ˜ (CTA ë²„íŠ¼ í´ë¦­)
    ctr: Number,                   // í´ë¦­ë¥  (clicks / impressions)
    uniqueVisitors: Number,        // ê³ ìœ  ë°©ë¬¸ì
    avgDwellTime: Number,          // í‰ê·  ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
  },

  // ë©”íƒ€
  createdBy: ObjectId,             // ìƒì„±ì (ê´€ë¦¬ì)
  createdAt: Date,
  updatedAt: Date,
}
```

### 2. AdEvent (ê´‘ê³  ì´ë²¤íŠ¸) - MongoDB

```javascript
{
  _id: ObjectId,

  // ê´‘ê³  ì •ë³´
  adId: ObjectId,                  // ê´‘ê³  ID (ref: Advertisement)
  adSlug: String,                  // ê´‘ê³  ìŠ¬ëŸ¬ê·¸

  // ì´ë²¤íŠ¸ ì •ë³´
  eventType: String,               // 'impression', 'click', 'dwell'
  eventData: {
    dwellTime: Number,             // ì²´ë¥˜ ì‹œê°„ (dwell ì´ë²¤íŠ¸ìš©)
    clickTarget: String,           // í´ë¦­ ëŒ€ìƒ ('cta', 'logo' ë“±)
  },

  // ì—°ê²°ëœ í¸ì§€ (ì–´ë–¤ í¸ì§€ì—ì„œ ì™”ëŠ”ì§€)
  letter: {
    letterId: ObjectId,
    letterType: String,
  },

  // ìœ ì… ê²½ë¡œ
  traffic: {
    source: String,                // 'qr', 'direct', 'link'
    medium: String,                // 'offline', 'email', 'social'
    campaign: String,              // UTM ìº í˜ì¸
    referrer: String,
  },

  // UTM íŒŒë¼ë¯¸í„°
  utm: {
    source: String,
    medium: String,
    campaign: String,
    content: String,
    term: String,
  },

  // ê¸°ê¸° ì •ë³´
  device: {
    type: String,                  // 'mobile', 'tablet', 'desktop'
    os: String,
    browser: String,
    screenWidth: Number,
    screenHeight: Number,
    userAgent: String,
  },

  // ì„¸ì…˜/ì‚¬ìš©ì
  session: {
    sessionId: String,
    visitorId: String,
    isNewVisitor: Boolean,
  },

  // ë©”íƒ€
  ip: String,                      // í•´ì‹œ ì²˜ë¦¬
  timestamp: Date,
  createdAt: Date,
}
```

### 3. AnalyticsEvent í™•ì¥ (ê¸°ì¡´ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€)

```javascript
{
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...

  // ê´‘ê³  ê´€ë ¨ (ê´‘ê³  í˜ì´ì§€ ì ‘ê·¼ ì‹œ)
  ad: {
    adId: ObjectId,
    adSlug: String,
    eventType: String,             // 'impression', 'click'
  },
}
```

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
# Frontend (Next.js)
app/
  ad/
    [adSlug]/
      page.tsx                    # ê´‘ê³  ëœë”© í˜ì´ì§€
      opengraph-image.tsx         # OG ì´ë¯¸ì§€ ë™ì  ìƒì„±
  api/
    ad/
      [adSlug]/
        route.ts                  # ê´‘ê³  ì •ë³´ ì¡°íšŒ
      track/
        route.ts                  # ê´‘ê³  ì´ë²¤íŠ¸ ì¶”ì 
    analytics/
      track/
        route.ts                  # ì¼ë°˜ ë¶„ì„ ì´ë²¤íŠ¸ ì¶”ì 

lib/
  analytics/
    index.ts
    tracker.ts
    device.ts
    session.ts
    utm.ts
    ad-tracker.ts                 # ê´‘ê³  ì „ìš© ì¶”ì 

components/
  ad/
    AdLandingPage.tsx             # ê´‘ê³  ëœë”© í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
    AdCTAButton.tsx               # CTA ë²„íŠ¼ (í´ë¦­ ì¶”ì  í¬í•¨)

# Backend (Express)
models/
  Advertisement.js                # ê´‘ê³  ëª¨ë¸
  AdEvent.js                      # ê´‘ê³  ì´ë²¤íŠ¸ ëª¨ë¸
  AnalyticsEvent.js               # ì¼ë°˜ ë¶„ì„ ì´ë²¤íŠ¸

routes/
  ad.routes.js                    # ê´‘ê³  API ë¼ìš°íŠ¸
  analytics.routes.js             # ë¶„ì„ API ë¼ìš°íŠ¸

controllers/
  ad.controller.js                # ê´‘ê³  ì»¨íŠ¸ë¡¤ëŸ¬
  analytics.controller.js         # ë¶„ì„ ì»¨íŠ¸ë¡¤ëŸ¬

# Admin
app/
  admin/
    ads/
      page.tsx                    # ê´‘ê³  ëª©ë¡
      new/page.tsx                # ê´‘ê³  ìƒì„±
      [adId]/
        page.tsx                  # ê´‘ê³  ìƒì„¸/ìˆ˜ì •
        stats/page.tsx            # ê´‘ê³  í†µê³„
    analytics/
      page.tsx                    # ë¶„ì„ ëŒ€ì‹œë³´ë“œ
      qr/page.tsx                 # QR ë¶„ì„
      ads/page.tsx                # ê´‘ê³  ë¶„ì„ ëŒ€ì‹œë³´ë“œ
```

---

## ğŸ”— QR ì½”ë“œ URL êµ¬ì¡°

### 1. ì¼ë°˜ í¸ì§€ QR (ê¸°ì¡´)

```
https://letter.community/letter/[letterId]
  ?utm_source=qr
  &utm_medium=offline
  &utm_campaign=wedding_invitation
```

### 2. ê´‘ê³  QR (ì‹ ê·œ)

```
https://letter.community/ad/[adSlug]
  ?utm_source=qr
  &utm_medium=offline
  &utm_campaign=spring_wedding_2024
  &letter=[letterId]              # ì–´ë–¤ í¸ì§€ì—ì„œ ì™”ëŠ”ì§€ (ì„ íƒ)
```

### 3. í¸ì§€ ë‚´ ê´‘ê³  ë§í¬ (í¸ì§€ í˜ì´ì§€ì—ì„œ ê´‘ê³ ë¡œ ì´ë™)

```
https://letter.community/ad/[adSlug]
  ?utm_source=letter
  &utm_medium=link
  &letter=[letterId]
```

---

# ğŸ¨ Frontend í”„ë¡¬í”„íŠ¸

## ğŸ“‹ ìš”êµ¬ì‚¬í•­

Next.js í”„ë¡œì íŠ¸ì— **ê´‘ê³  QR ëœë”© í˜ì´ì§€**ì™€ **ì›¹ ë¶„ì„ ì‹œìŠ¤í…œ**ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.

---

## ğŸ“¦ 1ë‹¨ê³„: íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
pnpm add uuid
pnpm add -D @types/uuid
```

---

## ğŸ¯ 2ë‹¨ê³„: ê´‘ê³  ëœë”© í˜ì´ì§€

### íŒŒì¼: `app/ad/[adSlug]/page.tsx`

```typescript
import { Metadata } from "next";
import { notFound } from "next/navigation";
import AdLandingClient from "./AdLandingClient";

const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL;

interface AdData {
  _id: string;
  slug: string;
  status: string;
  advertiser: {
    name: string;
    logo?: string;
  };
  content: {
    headline: string;
    description: string;
    ctaText: string;
    targetUrl: string;
    backgroundImage?: string;
    backgroundColor?: string;
    theme?: string;
  };
  campaign: {
    name: string;
    startDate: string;
    endDate: string;
  };
}

async function getAdData(adSlug: string): Promise<AdData | null> {
  try {
    const res = await fetch(`${BACKEND_URL}/api/ads/${adSlug}`, {
      next: { revalidate: 60 }, // 1ë¶„ ìºì‹œ
    });

    if (!res.ok) return null;

    const data = await res.json();
    return data.success ? data.data : null;
  } catch {
    return null;
  }
}

// ë™ì  ë©”íƒ€ë°ì´í„°
export async function generateMetadata({
  params,
}: {
  params: { adSlug: string };
}): Promise<Metadata> {
  const ad = await getAdData(params.adSlug);

  if (!ad) {
    return { title: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" };
  }

  return {
    title: `${ad.content.headline} | ${ad.advertiser.name}`,
    description: ad.content.description,
    openGraph: {
      title: ad.content.headline,
      description: ad.content.description,
      images: ad.content.backgroundImage ? [ad.content.backgroundImage] : [],
    },
  };
}

export default async function AdLandingPage({
  params,
  searchParams,
}: {
  params: { adSlug: string };
  searchParams: { [key: string]: string | undefined };
}) {
  const ad = await getAdData(params.adSlug);

  if (!ad) {
    notFound();
  }

  // ìº í˜ì¸ ê¸°ê°„ ì²´í¬
  const now = new Date();
  const startDate = new Date(ad.campaign.startDate);
  const endDate = new Date(ad.campaign.endDate);

  if (ad.status !== "active" || now < startDate || now > endDate) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center p-8">
          <h1 className="text-2xl font-bold text-gray-800 mb-4">
            ì´ í”„ë¡œëª¨ì…˜ì€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
          </h1>
          <p className="text-gray-600">ë‹¤ë¥¸ í˜œíƒì„ í™•ì¸í•´ë³´ì„¸ìš”!</p>
        </div>
      </div>
    );
  }

  return (
    <AdLandingClient
      ad={ad}
      letterId={searchParams.letter}
      utmSource={searchParams.utm_source}
      utmMedium={searchParams.utm_medium}
      utmCampaign={searchParams.utm_campaign}
    />
  );
}
```

### íŒŒì¼: `app/ad/[adSlug]/AdLandingClient.tsx`

```typescript
"use client";

import { useEffect, useState, useRef } from "react";
import Image from "next/image";
import {
  trackAdImpression,
  trackAdClick,
  trackAdDwell,
} from "@/lib/analytics/ad-tracker";

interface AdData {
  _id: string;
  slug: string;
  advertiser: {
    name: string;
    logo?: string;
  };
  content: {
    headline: string;
    description: string;
    ctaText: string;
    targetUrl: string;
    backgroundImage?: string;
    backgroundColor?: string;
    theme?: string;
  };
}

interface Props {
  ad: AdData;
  letterId?: string;
  utmSource?: string;
  utmMedium?: string;
  utmCampaign?: string;
}

export default function AdLandingClient({
  ad,
  letterId,
  utmSource,
  utmMedium,
  utmCampaign,
}: Props) {
  const [isLoading, setIsLoading] = useState(false);
  const startTimeRef = useRef<number>(Date.now());
  const hasTrackedImpression = useRef(false);

  // ë…¸ì¶œ ì¶”ì  (í˜ì´ì§€ ë¡œë“œ ì‹œ)
  useEffect(() => {
    if (!hasTrackedImpression.current) {
      trackAdImpression({
        adId: ad._id,
        adSlug: ad.slug,
        letterId,
        utm: {
          source: utmSource,
          medium: utmMedium,
          campaign: utmCampaign,
        },
      });
      hasTrackedImpression.current = true;
    }

    // ì²´ë¥˜ ì‹œê°„ ì¶”ì  (í˜ì´ì§€ ì´íƒˆ ì‹œ)
    const handleBeforeUnload = () => {
      const dwellTime = Math.floor((Date.now() - startTimeRef.current) / 1000);
      trackAdDwell({
        adId: ad._id,
        adSlug: ad.slug,
        dwellTime,
        letterId,
      });
    };

    window.addEventListener("beforeunload", handleBeforeUnload);
    return () => window.removeEventListener("beforeunload", handleBeforeUnload);
  }, [ad, letterId, utmSource, utmMedium, utmCampaign]);

  // CTA í´ë¦­ í•¸ë“¤ëŸ¬
  const handleCTAClick = async () => {
    setIsLoading(true);

    // í´ë¦­ ì¶”ì 
    await trackAdClick({
      adId: ad._id,
      adSlug: ad.slug,
      clickTarget: "cta",
      letterId,
      utm: {
        source: utmSource,
        medium: utmMedium,
        campaign: utmCampaign,
      },
    });

    // ì²´ë¥˜ ì‹œê°„ë„ í•¨ê»˜ ê¸°ë¡
    const dwellTime = Math.floor((Date.now() - startTimeRef.current) / 1000);
    await trackAdDwell({
      adId: ad._id,
      adSlug: ad.slug,
      dwellTime,
      letterId,
    });

    // ê´‘ê³ ì£¼ ì‚¬ì´íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    window.location.href = ad.content.targetUrl;
  };

  // í…Œë§ˆë³„ ìŠ¤íƒ€ì¼
  const getThemeStyles = () => {
    switch (ad.content.theme) {
      case "wedding":
        return {
          bg: "bg-gradient-to-br from-pink-50 to-rose-100",
          accent: "bg-rose-500 hover:bg-rose-600",
          text: "text-rose-900",
        };
      case "birthday":
        return {
          bg: "bg-gradient-to-br from-yellow-50 to-orange-100",
          accent: "bg-orange-500 hover:bg-orange-600",
          text: "text-orange-900",
        };
      case "congratulation":
        return {
          bg: "bg-gradient-to-br from-blue-50 to-indigo-100",
          accent: "bg-indigo-500 hover:bg-indigo-600",
          text: "text-indigo-900",
        };
      default:
        return {
          bg:
            ad.content.backgroundColor ||
            "bg-gradient-to-br from-gray-50 to-gray-100",
          accent: "bg-primary hover:bg-primary/90",
          text: "text-gray-900",
        };
    }
  };

  const theme = getThemeStyles();

  return (
    <div
      className={`min-h-screen flex flex-col items-center justify-center p-6 ${theme.bg}`}
      style={
        ad.content.backgroundImage
          ? {
              backgroundImage: `url(${ad.content.backgroundImage})`,
              backgroundSize: "cover",
              backgroundPosition: "center",
            }
          : undefined
      }
    >
      {/* ë©”ì¸ ì¹´ë“œ */}
      <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
        {/* ê´‘ê³ ì£¼ ë¡œê³  */}
        {ad.advertiser.logo && (
          <div className="p-6 flex justify-center border-b">
            <Image
              src={ad.advertiser.logo}
              alt={ad.advertiser.name}
              width={120}
              height={60}
              className="object-contain"
            />
          </div>
        )}

        {/* ì½˜í…ì¸  */}
        <div className="p-8 text-center">
          {/* í—¤ë“œë¼ì¸ */}
          <h1 className={`text-2xl md:text-3xl font-bold mb-4 ${theme.text}`}>
            {ad.content.headline}
          </h1>

          {/* ì„¤ëª… */}
          <p className="text-gray-600 mb-8 leading-relaxed">
            {ad.content.description}
          </p>

          {/* CTA ë²„íŠ¼ */}
          <button
            onClick={handleCTAClick}
            disabled={isLoading}
            className={`
              w-full py-4 px-6 rounded-xl text-white font-bold text-lg
              transition-all duration-200 transform hover:scale-105
              disabled:opacity-50 disabled:cursor-not-allowed
              ${theme.accent}
            `}
          >
            {isLoading ? (
              <span className="flex items-center justify-center gap-2">
                <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                    fill="none"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  />
                </svg>
                ì´ë™ ì¤‘...
              </span>
            ) : (
              <>{ad.content.ctaText} â†’</>
            )}
          </button>
        </div>

        {/* ê´‘ê³ ì£¼ ì •ë³´ */}
        <div className="px-8 pb-6 text-center">
          <p className="text-sm text-gray-400">{ad.advertiser.name} ì œê³µ</p>
        </div>
      </div>

      {/* Letter ë¸Œëœë”© */}
      <div className="mt-8 text-center">
        <p className="text-sm text-gray-500">ğŸ’Œ Letter Community</p>
      </div>
    </div>
  );
}
```

---

## ğŸ“Š 3ë‹¨ê³„: ê´‘ê³  ì¶”ì  ìœ í‹¸ë¦¬í‹°

### íŒŒì¼: `lib/analytics/ad-tracker.ts`

```typescript
import { getDeviceInfo } from "./device";
import { getOrCreateSession } from "./session";

interface AdTrackingData {
  adId: string;
  adSlug: string;
  letterId?: string;
  utm?: {
    source?: string;
    medium?: string;
    campaign?: string;
  };
}

interface AdClickData extends AdTrackingData {
  clickTarget: string;
}

interface AdDwellData extends AdTrackingData {
  dwellTime: number;
}

async function sendAdEvent(eventType: string, data: Record<string, any>) {
  try {
    const device = getDeviceInfo();
    const session = getOrCreateSession();

    await fetch("/api/ad/track", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        eventType,
        ...data,
        device,
        session,
        page: {
          path: window.location.pathname,
          referrer: document.referrer,
        },
        timestamp: new Date().toISOString(),
      }),
    });
  } catch (error) {
    console.error("Ad tracking error:", error);
  }
}

// ê´‘ê³  ë…¸ì¶œ ì¶”ì 
export async function trackAdImpression(data: AdTrackingData) {
  return sendAdEvent("impression", data);
}

// ê´‘ê³  í´ë¦­ ì¶”ì 
export async function trackAdClick(data: AdClickData) {
  return sendAdEvent("click", data);
}

// ê´‘ê³  ì²´ë¥˜ ì‹œê°„ ì¶”ì 
export async function trackAdDwell(data: AdDwellData) {
  // Beacon API ì‚¬ìš© (í˜ì´ì§€ ì´íƒˆ ì‹œì—ë„ ì „ì†¡ ë³´ì¥)
  const payload = JSON.stringify({
    eventType: "dwell",
    ...data,
    timestamp: new Date().toISOString(),
  });

  if (navigator.sendBeacon) {
    navigator.sendBeacon("/api/ad/track", payload);
  } else {
    return sendAdEvent("dwell", data);
  }
}
```

---

## ğŸ”€ 4ë‹¨ê³„: API Routes

### íŒŒì¼: `app/api/ad/[adSlug]/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";

const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL;

export async function GET(
  req: NextRequest,
  { params }: { params: { adSlug: string } }
) {
  try {
    const response = await fetch(`${BACKEND_URL}/api/ads/${params.adSlug}`);
    const data = await response.json();

    return NextResponse.json(data);
  } catch (error) {
    console.error("Ad fetch error:", error);
    return NextResponse.json(
      { success: false, error: "Failed to fetch ad" },
      { status: 500 }
    );
  }
}
```

### íŒŒì¼: `app/api/ad/track/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";

const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL;

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();

    // í´ë¼ì´ì–¸íŠ¸ IP ì¶”ì¶œ
    const ip =
      req.headers.get("x-forwarded-for")?.split(",")[0] ||
      req.headers.get("x-real-ip") ||
      "unknown";

    // ë°±ì—”ë“œë¡œ ì „ë‹¬
    const response = await fetch(`${BACKEND_URL}/api/ads/track`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...body, ip }),
    });

    if (!response.ok) {
      throw new Error("Backend error");
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Ad tracking error:", error);
    return NextResponse.json({ success: false }, { status: 200 });
  }
}
```

---

## ğŸ”— 5ë‹¨ê³„: QR ì½”ë“œ ìƒì„± ìœ í‹¸ë¦¬í‹°

### íŒŒì¼: `lib/qrcode.ts`

```typescript
const APP_URL = process.env.NEXT_PUBLIC_APP_URL || "https://letter.community";

// ì¼ë°˜ í¸ì§€ QR URL ìƒì„±
export function generateLetterQRUrl(
  letterId: string,
  campaign?: string
): string {
  const url = new URL(`/letter/${letterId}`, APP_URL);

  url.searchParams.set("utm_source", "qr");
  url.searchParams.set("utm_medium", "offline");
  if (campaign) {
    url.searchParams.set("utm_campaign", campaign);
  }

  return url.toString();
}

// ê´‘ê³  QR URL ìƒì„±
export function generateAdQRUrl(
  adSlug: string,
  options?: {
    letterId?: string;
    campaign?: string;
  }
): string {
  const url = new URL(`/ad/${adSlug}`, APP_URL);

  url.searchParams.set("utm_source", "qr");
  url.searchParams.set("utm_medium", "offline");

  if (options?.letterId) {
    url.searchParams.set("letter", options.letterId);
  }
  if (options?.campaign) {
    url.searchParams.set("utm_campaign", options.campaign);
  }

  return url.toString();
}

// QR ì½”ë“œ ì´ë¯¸ì§€ URL ìƒì„± (ì™¸ë¶€ ì„œë¹„ìŠ¤ ì‚¬ìš©)
export function generateQRImageUrl(targetUrl: string, size = 200): string {
  // Google Charts API ì‚¬ìš© (ë¬´ë£Œ)
  return `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(
    targetUrl
  )}`;
}
```

---

## âœ… Frontend ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `uuid` íŒ¨í‚¤ì§€ ì„¤ì¹˜
- [ ] `app/ad/[adSlug]/page.tsx` ìƒì„±
- [ ] `app/ad/[adSlug]/AdLandingClient.tsx` ìƒì„±
- [ ] `lib/analytics/ad-tracker.ts` ìƒì„±
- [ ] `app/api/ad/[adSlug]/route.ts` ìƒì„±
- [ ] `app/api/ad/track/route.ts` ìƒì„±
- [ ] `lib/qrcode.ts` ìƒì„±
- [ ] ê¸°ì¡´ ë¶„ì„ ìœ í‹¸ë¦¬í‹° (`lib/analytics/`) ìƒì„±

---

# ğŸ–¥ï¸ Backend í”„ë¡¬í”„íŠ¸

## ğŸ“‹ ìš”êµ¬ì‚¬í•­

Express.js ë°±ì—”ë“œì— **ê´‘ê³  ê´€ë¦¬ API**ì™€ **ì›¹ ë¶„ì„ ì‹œìŠ¤í…œ**ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.

---

## ğŸ“¦ 1ë‹¨ê³„: ëª¨ë¸ ìƒì„±

### íŒŒì¼: `models/Advertisement.js`

```javascript
const mongoose = require("mongoose");

const advertisementSchema = new mongoose.Schema(
  {
    // ê¸°ë³¸ ì •ë³´
    name: {
      type: String,
      required: true,
      trim: true,
    },
    slug: {
      type: String,
      required: true,
      unique: true,
      lowercase: true,
      trim: true,
      index: true,
    },
    status: {
      type: String,
      enum: ["draft", "active", "paused", "expired"],
      default: "draft",
      index: true,
    },

    // ê´‘ê³ ì£¼ ì •ë³´
    advertiser: {
      name: { type: String, required: true },
      logo: String,
      contactEmail: String,
      contactPhone: String,
    },

    // ê´‘ê³  ì½˜í…ì¸ 
    content: {
      headline: { type: String, required: true },
      description: { type: String, required: true },
      ctaText: { type: String, default: "ìì„¸íˆ ë³´ê¸°" },
      targetUrl: { type: String, required: true },
      backgroundImage: String,
      backgroundColor: { type: String, default: "#ffffff" },
      theme: {
        type: String,
        enum: ["wedding", "birthday", "congratulation", "general"],
        default: "general",
      },
    },

    // ìº í˜ì¸ ì„¤ì •
    campaign: {
      name: String,
      startDate: { type: Date, required: true },
      endDate: { type: Date, required: true },
      budget: Number,
      targetImpressions: Number,
      targetClicks: Number,
    },

    // ì—°ê²°ëœ í¸ì§€
    linkedLetters: [
      {
        letterId: { type: mongoose.Schema.Types.ObjectId, ref: "Letter" },
        letterType: String,
        addedAt: { type: Date, default: Date.now },
      },
    ],

    // ì‹¤ì‹œê°„ í†µê³„
    stats: {
      impressions: { type: Number, default: 0 },
      clicks: { type: Number, default: 0 },
      ctr: { type: Number, default: 0 },
      uniqueVisitors: { type: Number, default: 0 },
      avgDwellTime: { type: Number, default: 0 },
    },

    // ë©”íƒ€
    createdBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  {
    timestamps: true,
  }
);

// ìŠ¬ëŸ¬ê·¸ ìë™ ìƒì„±
advertisementSchema.pre("save", function (next) {
  if (!this.slug && this.name) {
    this.slug = this.name
      .toLowerCase()
      .replace(/[^a-z0-9ê°€-í£]/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }
  next();
});

// CTR ê³„ì‚°
advertisementSchema.methods.calculateCTR = function () {
  if (this.stats.impressions > 0) {
    this.stats.ctr = (this.stats.clicks / this.stats.impressions) * 100;
  }
  return this.stats.ctr;
};

// ì¸ë±ìŠ¤
advertisementSchema.index({ "campaign.startDate": 1, "campaign.endDate": 1 });
advertisementSchema.index({ status: 1, "campaign.endDate": 1 });

module.exports = mongoose.model("Advertisement", advertisementSchema);
```

### íŒŒì¼: `models/AdEvent.js`

```javascript
const mongoose = require("mongoose");

const adEventSchema = new mongoose.Schema(
  {
    // ê´‘ê³  ì •ë³´
    adId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Advertisement",
      required: true,
      index: true,
    },
    adSlug: {
      type: String,
      required: true,
      index: true,
    },

    // ì´ë²¤íŠ¸ ì •ë³´
    eventType: {
      type: String,
      required: true,
      enum: ["impression", "click", "dwell"],
      index: true,
    },
    eventData: {
      dwellTime: Number,
      clickTarget: String,
    },

    // ì—°ê²°ëœ í¸ì§€
    letter: {
      letterId: { type: mongoose.Schema.Types.ObjectId, ref: "Letter" },
      letterType: String,
    },

    // ìœ ì… ê²½ë¡œ
    traffic: {
      source: {
        type: String,
        enum: ["qr", "direct", "link", "social", "email", "other"],
        default: "direct",
      },
      medium: String,
      campaign: String,
      referrer: String,
    },

    // UTM íŒŒë¼ë¯¸í„°
    utm: {
      source: String,
      medium: String,
      campaign: String,
      content: String,
      term: String,
    },

    // ê¸°ê¸° ì •ë³´
    device: {
      type: { type: String, enum: ["mobile", "tablet", "desktop"] },
      os: String,
      browser: String,
      screenWidth: Number,
      screenHeight: Number,
      userAgent: String,
    },

    // ì„¸ì…˜/ì‚¬ìš©ì
    session: {
      sessionId: String,
      visitorId: { type: String, index: true },
      isNewVisitor: Boolean,
    },

    // ë©”íƒ€
    ip: String,
    timestamp: { type: Date, default: Date.now },
  },
  {
    timestamps: true,
  }
);

// ë³µí•© ì¸ë±ìŠ¤
adEventSchema.index({ adId: 1, eventType: 1, createdAt: -1 });
adEventSchema.index({ adSlug: 1, createdAt: -1 });
adEventSchema.index({ "traffic.source": 1, createdAt: -1 });
adEventSchema.index({ createdAt: -1 });

module.exports = mongoose.model("AdEvent", adEventSchema);
```

---

## ğŸ›£ï¸ 2ë‹¨ê³„: ë¼ìš°íŠ¸ ìƒì„±

### íŒŒì¼: `routes/ad.routes.js`

```javascript
const express = require("express");
const router = express.Router();
const adController = require("../controllers/ad.controller");
const {
  optionalAuth,
  requireAuth,
  requireAdmin,
} = require("../middleware/auth");

// ê³µê°œ API
router.get("/:adSlug", adController.getAdBySlug); // ê´‘ê³  ì •ë³´ ì¡°íšŒ
router.post("/track", adController.trackAdEvent); // ì´ë²¤íŠ¸ ì¶”ì 

// ê´€ë¦¬ì API
router.get("/", requireAdmin, adController.getAllAds); // ê´‘ê³  ëª©ë¡
router.post("/", requireAdmin, adController.createAd); // ê´‘ê³  ìƒì„±
router.put("/:adId", requireAdmin, adController.updateAd); // ê´‘ê³  ìˆ˜ì •
router.delete("/:adId", requireAdmin, adController.deleteAd); // ê´‘ê³  ì‚­ì œ
router.get("/:adId/stats", requireAdmin, adController.getAdStats); // ê´‘ê³  í†µê³„

// ê´‘ê³ -í¸ì§€ ì—°ê²°
router.post("/:adId/link-letter", requireAdmin, adController.linkLetter);
router.delete(
  "/:adId/unlink-letter/:letterId",
  requireAdmin,
  adController.unlinkLetter
);

module.exports = router;
```

### íŒŒì¼: `app.js`ì— ì¶”ê°€

```javascript
const adRoutes = require("./routes/ad.routes");

app.use("/api/ads", adRoutes);
```

---

## ğŸ® 3ë‹¨ê³„: ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±

### íŒŒì¼: `controllers/ad.controller.js`

```javascript
const Advertisement = require("../models/Advertisement");
const AdEvent = require("../models/AdEvent");
const crypto = require("crypto");

// IP í•´ì‹œ í•¨ìˆ˜
function hashIP(ip) {
  if (!ip) return "unknown";
  return crypto
    .createHash("sha256")
    .update(ip + (process.env.IP_SALT || "letter"))
    .digest("hex")
    .substring(0, 16);
}

// ìœ ì… ê²½ë¡œ ë¶„ì„
function analyzeTrafficSource(utm, referrer) {
  if (utm?.source === "qr" || utm?.medium === "offline") {
    return {
      source: "qr",
      medium: utm.medium || "offline",
      campaign: utm.campaign,
    };
  }
  if (utm?.source === "letter") {
    return { source: "link", medium: "letter", campaign: utm.campaign };
  }
  if (referrer) {
    return { source: "referral", medium: "link", referrer };
  }
  return { source: "direct", medium: "none" };
}

// ê´‘ê³  ì •ë³´ ì¡°íšŒ (ê³µê°œ)
exports.getAdBySlug = async (req, res) => {
  try {
    const { adSlug } = req.params;

    const ad = await Advertisement.findOne({
      slug: adSlug,
      status: { $in: ["active", "paused"] }, // draft, expired ì œì™¸
    }).select("-createdBy -__v");

    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    res.json({
      success: true,
      data: ad,
    });
  } catch (error) {
    console.error("Get ad error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// ì´ë²¤íŠ¸ ì¶”ì 
exports.trackAdEvent = async (req, res) => {
  try {
    const {
      eventType,
      adId,
      adSlug,
      letterId,
      clickTarget,
      dwellTime,
      utm,
      device,
      session,
      page,
      ip,
    } = req.body;

    // ìœ ì… ê²½ë¡œ ë¶„ì„
    const traffic = analyzeTrafficSource(utm, page?.referrer);

    // ì´ë²¤íŠ¸ ì €ì¥
    const event = new AdEvent({
      adId,
      adSlug,
      eventType,
      eventData: {
        dwellTime,
        clickTarget,
      },
      letter: letterId ? { letterId } : undefined,
      traffic,
      utm,
      device,
      session,
      ip: hashIP(ip || req.ip),
      timestamp: new Date(),
    });

    await event.save();

    // ê´‘ê³  í†µê³„ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸°)
    updateAdStats(adId, eventType, session?.visitorId, dwellTime).catch(
      console.error
    );

    res.json({ success: true });
  } catch (error) {
    console.error("Track ad event error:", error);
    res.json({ success: false }); // ì—ëŸ¬ì—¬ë„ 200 ë°˜í™˜
  }
};

// ê´‘ê³  í†µê³„ ì—…ë°ì´íŠ¸
async function updateAdStats(adId, eventType, visitorId, dwellTime) {
  const updateQuery = { $inc: {} };

  if (eventType === "impression") {
    updateQuery.$inc["stats.impressions"] = 1;
  }

  if (eventType === "click") {
    updateQuery.$inc["stats.clicks"] = 1;
  }

  const ad = await Advertisement.findByIdAndUpdate(adId, updateQuery, {
    new: true,
  });

  if (ad) {
    // CTR ì¬ê³„ì‚°
    ad.calculateCTR();
    await ad.save();
  }

  // ê³ ìœ  ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸ (ë³„ë„ ì§‘ê³„)
  if (eventType === "impression" && visitorId) {
    const uniqueCount = await AdEvent.distinct("session.visitorId", {
      adId,
      eventType: "impression",
    });

    await Advertisement.findByIdAndUpdate(adId, {
      "stats.uniqueVisitors": uniqueCount.length,
    });
  }

  // í‰ê·  ì²´ë¥˜ ì‹œê°„ ì—…ë°ì´íŠ¸
  if (eventType === "dwell" && dwellTime) {
    const dwellEvents = await AdEvent.find({
      adId,
      eventType: "dwell",
      "eventData.dwellTime": { $exists: true },
    }).select("eventData.dwellTime");

    if (dwellEvents.length > 0) {
      const totalDwell = dwellEvents.reduce(
        (sum, e) => sum + (e.eventData?.dwellTime || 0),
        0
      );
      const avgDwell = Math.round(totalDwell / dwellEvents.length);

      await Advertisement.findByIdAndUpdate(adId, {
        "stats.avgDwellTime": avgDwell,
      });
    }
  }
}

// ê´‘ê³  ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì)
exports.getAllAds = async (req, res) => {
  try {
    const { status, page = 1, limit = 20 } = req.query;

    const query = {};
    if (status) query.status = status;

    const ads = await Advertisement.find(query)
      .sort({ createdAt: -1 })
      .skip((page - 1) * limit)
      .limit(parseInt(limit))
      .populate("createdBy", "name email");

    const total = await Advertisement.countDocuments(query);

    res.json({
      success: true,
      data: ads,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        totalPages: Math.ceil(total / limit),
      },
    });
  } catch (error) {
    console.error("Get all ads error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// ê´‘ê³  ìƒì„± (ê´€ë¦¬ì)
exports.createAd = async (req, res) => {
  try {
    const adData = {
      ...req.body,
      createdBy: req.user._id,
    };

    const ad = new Advertisement(adData);
    await ad.save();

    res.status(201).json({
      success: true,
      data: ad,
    });
  } catch (error) {
    console.error("Create ad error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// ê´‘ê³  ìˆ˜ì • (ê´€ë¦¬ì)
exports.updateAd = async (req, res) => {
  try {
    const { adId } = req.params;

    const ad = await Advertisement.findByIdAndUpdate(
      adId,
      { $set: req.body },
      { new: true, runValidators: true }
    );

    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    res.json({
      success: true,
      data: ad,
    });
  } catch (error) {
    console.error("Update ad error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// ê´‘ê³  ì‚­ì œ (ê´€ë¦¬ì)
exports.deleteAd = async (req, res) => {
  try {
    const { adId } = req.params;

    const ad = await Advertisement.findByIdAndDelete(adId);

    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    // ê´€ë ¨ ì´ë²¤íŠ¸ë„ ì‚­ì œ (ì„ íƒì )
    await AdEvent.deleteMany({ adId });

    res.json({
      success: true,
      message: "ê´‘ê³ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",
    });
  } catch (error) {
    console.error("Delete ad error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// ê´‘ê³  í†µê³„ ì¡°íšŒ (ê´€ë¦¬ì)
exports.getAdStats = async (req, res) => {
  try {
    const { adId } = req.params;
    const { startDate, endDate } = req.query;

    const start = startDate
      ? new Date(startDate)
      : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
    const end = endDate ? new Date(endDate) : new Date();

    const ad = await Advertisement.findById(adId);
    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    // ê¸°ê°„ë³„ í†µê³„
    const [impressions, clicks, byDate, bySource, byDevice] = await Promise.all(
      [
        // ë…¸ì¶œìˆ˜
        AdEvent.countDocuments({
          adId,
          eventType: "impression",
          createdAt: { $gte: start, $lte: end },
        }),

        // í´ë¦­ìˆ˜
        AdEvent.countDocuments({
          adId,
          eventType: "click",
          createdAt: { $gte: start, $lte: end },
        }),

        // ì¼ë³„ ì¶”ì´
        AdEvent.aggregate([
          {
            $match: {
              adId: ad._id,
              eventType: { $in: ["impression", "click"] },
              createdAt: { $gte: start, $lte: end },
            },
          },
          {
            $group: {
              _id: {
                date: {
                  $dateToString: { format: "%Y-%m-%d", date: "$createdAt" },
                },
                eventType: "$eventType",
              },
              count: { $sum: 1 },
            },
          },
          { $sort: { "_id.date": 1 } },
        ]),

        // ìœ ì… ê²½ë¡œë³„
        AdEvent.aggregate([
          {
            $match: {
              adId: ad._id,
              eventType: "impression",
              createdAt: { $gte: start, $lte: end },
            },
          },
          {
            $group: {
              _id: "$traffic.source",
              count: { $sum: 1 },
            },
          },
          { $sort: { count: -1 } },
        ]),

        // ê¸°ê¸°ë³„
        AdEvent.aggregate([
          {
            $match: {
              adId: ad._id,
              eventType: "impression",
              createdAt: { $gte: start, $lte: end },
            },
          },
          {
            $group: {
              _id: "$device.type",
              count: { $sum: 1 },
            },
          },
          { $sort: { count: -1 } },
        ]),
      ]
    );

    // ì¼ë³„ ë°ì´í„° ì •ë¦¬
    const dailyData = {};
    byDate.forEach((item) => {
      const date = item._id.date;
      if (!dailyData[date]) {
        dailyData[date] = { date, impressions: 0, clicks: 0 };
      }
      dailyData[date][
        item._id.eventType === "impression" ? "impressions" : "clicks"
      ] = item.count;
    });

    res.json({
      success: true,
      data: {
        ad: {
          _id: ad._id,
          name: ad.name,
          slug: ad.slug,
          status: ad.status,
        },
        summary: {
          impressions,
          clicks,
          ctr: impressions > 0 ? ((clicks / impressions) * 100).toFixed(2) : 0,
          uniqueVisitors: ad.stats.uniqueVisitors,
          avgDwellTime: ad.stats.avgDwellTime,
        },
        daily: Object.values(dailyData),
        bySource,
        byDevice,
      },
      period: { start, end },
    });
  } catch (error) {
    console.error("Get ad stats error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// í¸ì§€-ê´‘ê³  ì—°ê²°
exports.linkLetter = async (req, res) => {
  try {
    const { adId } = req.params;
    const { letterId, letterType } = req.body;

    const ad = await Advertisement.findByIdAndUpdate(
      adId,
      {
        $addToSet: {
          linkedLetters: { letterId, letterType, addedAt: new Date() },
        },
      },
      { new: true }
    );

    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    res.json({
      success: true,
      data: ad,
    });
  } catch (error) {
    console.error("Link letter error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};

// í¸ì§€-ê´‘ê³  ì—°ê²° í•´ì œ
exports.unlinkLetter = async (req, res) => {
  try {
    const { adId, letterId } = req.params;

    const ad = await Advertisement.findByIdAndUpdate(
      adId,
      {
        $pull: {
          linkedLetters: { letterId },
        },
      },
      { new: true }
    );

    if (!ad) {
      return res.status(404).json({
        success: false,
        error: "ê´‘ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    res.json({
      success: true,
      data: ad,
    });
  } catch (error) {
    console.error("Unlink letter error:", error);
    res.status(500).json({ success: false, error: error.message });
  }
};
```

---

## âœ… Backend ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `models/Advertisement.js` ìƒì„±
- [ ] `models/AdEvent.js` ìƒì„±
- [ ] `routes/ad.routes.js` ìƒì„±
- [ ] `controllers/ad.controller.js` ìƒì„±
- [ ] `app.js`ì— ë¼ìš°íŠ¸ ë“±ë¡
- [ ] ê´€ë¦¬ì ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ í™•ì¸
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸

---
